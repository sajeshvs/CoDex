<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mantra Compatibility & Bƒ´ja Calculator - Enhanced</title>
<style>
:root {
  --primary: #6b46c1;
  --good: #16a34a;
  --neutral: #ca8a04;
  --bad: #dc2626;
  --good-bg: #dcfce7;
  --neutral-bg: #fef3c7;
  --bad-bg: #fee2e2;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body { 
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
}

.container { 
  background: white; 
  padding: 30px; 
  border-radius: 15px; 
  max-width: 1000px; 
  margin: auto; 
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

h1 { 
  color: var(--primary); 
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.subtitle {
  color: #666;
  margin-bottom: 30px;
  font-size: 14px;
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

.form-group {
  display: flex;
  flex-direction: column;
}

label { 
  font-weight: 600;
  margin-bottom: 5px;
  color: #333;
  display: flex;
  align-items: center;
  gap: 5px;
}

.help-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #e5e7eb;
  color: #6b7280;
  font-size: 12px;
  cursor: help;
  position: relative;
}

.help-icon:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 25px;
  left: 50%;
  transform: translateX(-50%);
  background: #1f2937;
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 12px;
  white-space: normal;
  width: 250px;
  z-index: 10;
}

input, select, textarea { 
  padding: 10px; 
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 14px;
  transition: all 0.3s;
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(107, 70, 193, 0.1);
}

button { 
  padding: 12px 24px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 16px;
}

button:hover {
  background: #553c9a;
  transform: translateY(-2px);
  box-shadow: 0 10px 20px rgba(107, 70, 193, 0.3);
}

button.secondary {
  background: #6b7280;
}

button.secondary:hover {
  background: #4b5563;
}

.button-group {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.result { 
  margin-top: 30px; 
  padding: 20px; 
  border-radius: 10px;
  background: #f9fafb;
  border: 2px solid #e5e7eb;
}

.result h3 {
  color: var(--primary);
  margin-bottom: 15px;
}

.result-item {
  padding: 10px;
  margin: 10px 0;
  border-radius: 6px;
  border-left: 4px solid;
}

.result-good {
  background: var(--good-bg);
  border-color: var(--good);
}

.result-neutral {
  background: var(--neutral-bg);
  border-color: var(--neutral);
}

.result-bad {
  background: var(--bad-bg);
  border-color: var(--bad);
}

.result-label {
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 5px;
}

.tabs {
  display: flex;
  gap: 10px;
  margin-top: 30px;
  margin-bottom: 20px;
  border-bottom: 2px solid #e5e7eb;
}

.tab {
  padding: 10px 20px;
  background: none;
  border: none;
  color: #6b7280;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.3s;
  border-bottom: 3px solid transparent;
  margin-bottom: -2px;
}

.tab.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

textarea { 
  font-family: 'Courier New', monospace;
  min-height: 150px;
  resize: vertical;
}

.aksara-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
  gap: 5px;
  margin: 20px 0;
  padding: 15px;
  background: #f9fafb;
  border-radius: 8px;
}

.aksara-cell {
  padding: 8px;
  text-align: center;
  border-radius: 4px;
  font-weight: 500;
  font-size: 14px;
}

.aksara-siddha { background: var(--good-bg); color: var(--good); }
.aksara-sadhya { background: #ddd6fe; color: #7c3aed; }
.aksara-susiddha { background: #bfdbfe; color: #2563eb; }
.aksara-ari { background: var(--bad-bg); color: var(--bad); }

.score-meter {
  width: 100%;
  height: 30px;
  background: #e5e7eb;
  border-radius: 15px;
  overflow: hidden;
  margin: 20px 0;
  position: relative;
}

.score-fill {
  height: 100%;
  transition: width 0.5s ease;
}

.score-good { background: var(--good); }
.score-neutral { background: var(--neutral); }
.score-bad { background: var(--bad); }

.score-label {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-weight: 600;
  color: white;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

.help-section {
  line-height: 1.8;
  color: #4b5563;
}

.help-section h4 {
  color: var(--primary);
  margin-top: 20px;
  margin-bottom: 10px;
}

.help-section ul {
  margin-left: 20px;
}

@media (max-width: 640px) {
  .container { padding: 20px; }
  .form-grid { grid-template-columns: 1fr; }
  .tabs { flex-wrap: wrap; }
  .tab { font-size: 14px; padding: 8px 12px; }
}

.hidden { display: none !important; }
</style>
</head>
<body>
<div class="container">
  <h1>üïâÔ∏è Mantra Compatibility & Bƒ´ja Calculator</h1>
  <div class="subtitle">Traditional ≈öƒÅkta/ƒÄgamic compatibility analysis for mantra initiation</div>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('main')">Calculator</button>
    <button class="tab" onclick="switchTab('custom')">Customization</button>
    <button class="tab" onclick="switchTab('help')">Help</button>
  </div>

  <div id="mainTab" class="tab-content active">
    <div class="form-grid">
      <div class="form-group">
        <label>
          Your Name
          <span class="help-icon" data-tooltip="Enter your first name or spiritual name. The first syllable will be analyzed.">?</span>
        </label>
        <input type="text" id="nameInput" placeholder="e.g., Ashish, Devi, Ram">
      </div>

      <div class="form-group">
        <label>
          Proposed Mantra
          <span class="help-icon" data-tooltip="Enter the full mantra or just its first word. Common prefixes like Om will be automatically handled.">?</span>
        </label>
        <input type="text" id="mantraInput" placeholder="e.g., Om Namah Shivaya, Klƒ´·πÉ">
      </div>

      <div class="form-group">
        <label>
          Birth Nak·π£atra (Optional)
          <span class="help-icon" data-tooltip="Your birth star constellation for deeper compatibility analysis using the Tara Bala system.">?</span>
        </label>
        <select id="nakshatraInput"></select>
      </div>

      <div class="form-group">
        <label>
          Birth RƒÅ≈õi / Moon Sign (Optional)
          <span class="help-icon" data-tooltip="Your moon sign for house position analysis to determine favorable placement.">?</span>
        </label>
        <select id="rashiInput"></select>
      </div>
    </div>

    <div class="button-group">
      <button onclick="calculate()">Calculate Compatibility</button>
      <button class="secondary" onclick="clearForm()">Clear</button>
      <button class="secondary" onclick="showAksaraChart()">View Ak·π£ara Chart</button>
    </div>

    <div id="output" class="result hidden"></div>

    <div id="aksaraChart" class="hidden">
      <h3>Ak·π£ara Cakra Reference</h3>
      <div class="aksara-grid" id="aksaraGrid"></div>
    </div>
  </div>

  <div id="customTab" class="tab-content">
    <h3>Customize Mappings</h3>
    
    <div class="form-group">
      <label>Letter Groups (JSON)</label>
      <textarea id="letterGroups"></textarea>
    </div>

    <div class="form-group">
      <label>Bƒ´ja Mantra Mapping (JSON)</label>
      <textarea id="bijaMapping"></textarea>
    </div>

    <div class="form-group">
      <label>Letter to Nak·π£atra Mapping (JSON)</label>
      <textarea id="letterNakMapping"></textarea>
    </div>

    <div class="form-group">
      <label>Letter to RƒÅ≈õi Mapping (JSON)</label>
      <textarea id="letterRashiMapping"></textarea>
    </div>

    <div class="button-group">
      <button onclick="loadDefaults()">Reset to Defaults</button>
      <button onclick="saveCustom()">Save Changes</button>
      <button class="secondary" onclick="exportSettings()">Export Settings</button>
      <button class="secondary" onclick="importSettings()">Import Settings</button>
    </div>
  </div>

  <div id="helpTab" class="tab-content">
    <div class="help-section">
      <h3>How to Use This Tool</h3>
      
      <h4>Categories Explained:</h4>
      <ul>
        <li><strong style="color: var(--good);">Siddha:</strong> Already accomplished, most favorable - brings quick results</li>
        <li><strong style="color: #7c3aed;">SƒÅdhya:</strong> To be accomplished - requires dedicated practice and effort</li>
        <li><strong style="color: #2563eb;">Susiddha:</strong> Easily accomplished - favorable with moderate effort</li>
        <li><strong style="color: var(--bad);">Ari:</strong> Hostile/enemy - should be avoided, may cause obstacles</li>
      </ul>

      <h4>Compatibility Logic:</h4>
      <ul>
        <li><strong>Letter Match:</strong> First syllable of name vs. first syllable of mantra determines base category</li>
        <li><strong>Nak·π£atra Tara:</strong> 9-fold cycle (Janma, Sampat, Vipat, etc.) determines stellar compatibility</li>
        <li><strong>RƒÅ≈õi Houses:</strong> 1-12 house positions show zodiacal harmony (trines are favorable)</li>
        <li><strong>Overall Score:</strong> Weighted combination of all factors (0-100 scale)</li>
      </ul>

      <h4>Interpretation Guide:</h4>
      <ul>
        <li><strong>80-100:</strong> Highly favorable - proceed with confidence</li>
        <li><strong>60-79:</strong> Favorable - good with proper guidance</li>
        <li><strong>40-59:</strong> Neutral - requires extra effort and dedication</li>
        <li><strong>20-39:</strong> Challenging - reconsider or seek alternatives</li>
        <li><strong>0-19:</strong> Unfavorable - strongly advised to choose different mantra</li>
      </ul>

      <h4>Traditional Sources:</h4>
      <p>Based on authoritative texts including:</p>
      <ul>
        <li>Mantra Mahodadhi by Mahƒ´dhara</li>
        <li>Mantra MahƒÅr·πáava</li>
        <li>≈öƒÅradƒÅ Tilaka Tantra</li>
        <li>Various ƒÄgamic and Tantric traditions</li>
      </ul>
      
      <p style="margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid var(--neutral);">
        <strong>Important:</strong> This tool provides traditional compatibility analysis. Always consult a qualified guru for proper mantra initiation (dƒ´k·π£ƒÅ).
      </p>
    </div>
  </div>
</div>

<script>
// Data Arrays
const nakshatras = [
  "Ashwini","Bharani","Krittika","Rohini","Mrigashira","Ardra",
  "Punarvasu","Pushya","Ashlesha","Magha","Purva Phalguni","Uttara Phalguni",
  "Hasta","Chitra","Swati","Vishakha","Anuradha","Jyeshtha",
  "Mula","Purva Ashadha","Uttara Ashadha","Shravana","Dhanishta",
  "Shatabhisha","Purva Bhadrapada","Uttara Bhadrapada","Revati"
];

const rashis = [
  "Mesha (Aries)","Vrishabha (Taurus)","Mithuna (Gemini)","Karka (Cancer)",
  "Simha (Leo)","Kanya (Virgo)","Tula (Libra)","Vrishchika (Scorpio)",
  "Dhanu (Sagittarius)","Makara (Capricorn)","Kumbha (Aquarius)","Meena (Pisces)"
];

// Complete Letter Groups based on traditional sources
const defaultLetterGroups = {
  siddha: ["a","ƒÅ","i","ƒ´","ka","kha","ca","cha","·π≠a","ta","pa","ya","≈õa"],
  sadhya: ["u","≈´","ga","gha","·πÖa","ja","jha","√±a","·π≠ha","tha","pha","ra","·π£a"],
  susiddha: ["·πõ","·πù","·∏∑","·∏π","e","ai","·∏ça","·∏çha","·πáa","da","dha","na","ba","la","sa"],
  ari: ["o","au","a·πÉ","a·∏•","bha","ma","va","ha","·∏∑a","k·π£a"]
};

// Extended Bƒ´ja mappings
const defaultBijaMapping = {
  "a":"‡§Ö‡§Ç","ƒÅ":"‡§Ü‡§Ç","i":"‡§á‡§Ç","ƒ´":"‡§à‡§Ç","u":"‡§â‡§Ç","≈´":"‡§ä‡§Ç",
  "·πõ":"‡§ã‡§Ç","·πù":"‡•†‡§Ç","·∏∑":"‡§å‡§Ç","·∏π":"‡•°‡§Ç","e":"‡§è‡§Ç","ai":"‡§ê‡§Ç",
  "o":"‡§ì‡§Ç","au":"‡§î‡§Ç","a·πÉ":"‡§Ö‡§Ç","a·∏•":"‡§Ö‡§É",
  "ka":"‡§ï‡§Ç","kha":"‡§ñ‡§Ç","ga":"‡§ó‡§Ç","gha":"‡§ò‡§Ç","·πÖa":"‡§ô‡§Ç",
  "ca":"‡§ö‡§Ç","cha":"‡§õ‡§Ç","ja":"‡§ú‡§Ç","jha":"‡§ù‡§Ç","√±a":"‡§û‡§Ç",
  "·π≠a":"‡§ü‡§Ç","·π≠ha":"‡§†‡§Ç","·∏ça":"‡§°‡§Ç","·∏çha":"‡§¢‡§Ç","·πáa":"‡§£‡§Ç",
  "ta":"‡§§‡§Ç","tha":"‡§•‡§Ç","da":"‡§¶‡§Ç","dha":"‡§ß‡§Ç","na":"‡§®‡§Ç",
  "pa":"‡§™‡§Ç","pha":"‡§´‡§Ç","ba":"‡§¨‡§Ç","bha":"‡§≠‡§Ç","ma":"‡§Æ‡§Ç",
  "ya":"‡§Ø‡§Ç","ra":"‡§∞‡§Ç","la":"‡§≤‡§Ç","va":"‡§µ‡§Ç",
  "≈õa":"‡§∂‡§Ç","·π£a":"‡§∑‡§Ç","sa":"‡§∏‡§Ç","ha":"‡§π‡§Ç",
  "·∏∑a":"‡§≥‡§Ç","k·π£a":"‡§ï‡•ç‡§∑‡§Ç","j√±a":"‡§ú‡•ç‡§û‡§Ç"
};

// Complete Nak·π£atra mappings (simplified for first letters)
const defaultLetterNakMapping = {
  "a":2, "ƒÅ":2, "i":2, "ƒ´":2, // Krittika
  "u":1, "≈´":1, // Bharani
  "·πõ":4, "·πù":4, // Mrigashira
  "·∏∑":0, "·∏π":0, // Ashwini
  "e":2, "ai":13, // Krittika, Chitra
  "o":3, "au":19, // Rohini, P.Ashadha
  "ka":4, "kha":21, "ga":22, "gha":5, "·πÖa":5, // Various
  "ca":26, "cha":5, "ja":20, "jha":25, "√±a":25, // Various
  "·π≠a":10, "·π≠ha":12, "·∏ça":7, "·∏çha":19, "·πáa":12, // Various
  "ta":14, "tha":25, "da":24, "dha":19, "na":16, // Various
  "pa":11, "pha":19, "ba":20, "bha":18, "ma":9, // Various
  "ya":17, "ra":13, "la":0, "va":3, // Various
  "≈õa":24, "·π£a":12, "sa":23, "ha":6, // Various
  "·∏∑a":0, "k·π£a":15, "j√±a":16 // Various
};

// RƒÅ≈õi mappings
const defaultLetterRashiMapping = {
  "a":0, "ƒÅ":0, "i":0, "ƒ´":0, // Mesha
  "u":1, "≈´":1, // Vrishabha
  "·πõ":2, "·πù":2, // Mithuna
  "·∏∑":3, "·∏π":3, "e":3, // Karka
  "ai":4, "o":4, "au":4, // Simha
  "ka":1, "kha":10, "ga":10, "gha":2, "·πÖa":2, // Various
  "ca":11, "cha":2, "ja":9, "jha":11, "√±a":11, // Various
  "·π≠a":4, "·π≠ha":5, "·∏ça":3, "·∏çha":9, "·πáa":5, // Various
  "ta":6, "tha":11, "da":11, "dha":9, "na":7, // Various
  "pa":5, "pha":9, "ba":8, "bha":8, "ma":4, // Various
  "ya":8, "ra":6, "la":0, "va":1, // Various
  "≈õa":10, "·π£a":5, "sa":11, "ha":3, // Various
  "·∏∑a":0, "k·π£a":7, "j√±a":7 // Various
};

let currentLetterGroups = JSON.parse(JSON.stringify(defaultLetterGroups));
let currentBijaMapping = JSON.parse(JSON.stringify(defaultBijaMapping));
let currentLetterNakMapping = JSON.parse(JSON.stringify(defaultLetterNakMapping));
let currentLetterRashiMapping = JSON.parse(JSON.stringify(defaultLetterRashiMapping));

// Initialize
window.onload = function() {
  populateDropdowns();
  loadFromStorage();
  loadDefaults();
};

function populateDropdowns() {
  const nakSelect = document.getElementById("nakshatraInput");
  const rashiSelect = document.getElementById("rashiInput");
  
  nakSelect.innerHTML = '<option value="">-- Select Nak·π£atra (Optional) --</option>';
  rashiSelect.innerHTML = '<option value="">-- Select RƒÅ≈õi (Optional) --</option>';
  
  nakshatras.forEach(n => nakSelect.innerHTML += `<option value="${n}">${n}</option>`);
  rashis.forEach(r => rashiSelect.innerHTML += `<option value="${r}">${r}</option>`);
}

// Enhanced syllable parser
function parseFirstSyllable(text) {
  text = text.trim().toLowerCase();
  
  // Remove common mantra prefixes
  const prefixes = ['om', 'o·πÉ', 'au·πÉ', 'hrƒ´·πÉ', '≈õrƒ´·πÉ', 'klƒ´·πÉ', 'ai·πÉ', 'sau·∏•', 'ga·πÉ', 'glau·πÉ'];
  for (let prefix of prefixes) {
    if (text.startsWith(prefix + ' ')) {
      text = text.substring(prefix.length + 1);
      break;
    }
  }
  
  // Check for two-letter combinations first
  const twoChar = ['k·π£', 'j√±', 'ai', 'au', 'kh', 'gh', 'ch', 'jh', '·π≠h', '·∏çh', 'th', 'dh', 'ph', 'bh'];
  for (let combo of twoChar) {
    if (text.startsWith(combo)) return combo;
  }
  
  // Check for vowels with diacritics
  const vowels = ['ƒÅ', 'ƒ´', '≈´', '·πõ', '·πù', '·∏∑', '·∏π', 'e', 'o', 'a·πÉ', 'a·∏•'];
  for (let vowel of vowels) {
    if (text.startsWith(vowel)) return vowel;
  }
  
  // Single consonants with diacritics
  const consonants = ['·πÖ', '√±', '·πá', '·π≠', '·∏ç', '≈õ', '·π£', '·∏•', '·πÉ', '·∏∑'];
  for (let cons of consonants) {
    if (text.startsWith(cons)) return cons;
  }
  
  // Default to first character
  return text[0] || '';
}

function findCategory(letter) {
  for (let key in currentLetterGroups) {
    if (currentLetterGroups[key].includes(letter)) return key;
  }
  return "unknown";
}

function nakshatraCompatibility(userNak, mantraNak) {
  if (userNak < 0 || mantraNak < 0) return null;
  
  let diff = (mantraNak - userNak + 27) % 27;
  const taraTypes = [
    "Janma", "Sampat", "Vipat", "K·π£ema", "Pratyari", 
    "SƒÅdhaka", "Vadha", "Mitra", "Parama-Mitra"
  ];
  
  let taraIndex = diff % 9;
  let tara = taraTypes[taraIndex];
  
  let score = 50; // Base score
  const scores = {
    "Janma": 50, "Sampat": 90, "Vipat": 20, "K·π£ema": 80, 
    "Pratyari": 30, "SƒÅdhaka": 70, "Vadha": 10, "Mitra": 85, "Parama-Mitra": 95
  };
  score = scores[tara] || 50;
  
  let note = (score >= 70) ? "Favorable" : (score <= 30) ? "Unfavorable" : "Neutral";
  
  return {tara, note, score};
}

function rashiCompatibility(userR, mantraR) {
  if (userR < 0 || mantraR < 0) return null;
  
  let diff = (mantraR - userR + 12) % 12 + 1;
  
  let score = 50; // Base score
  if ([1, 5, 9].includes(diff)) score = 85; // Trines - favorable
  else if ([3, 7, 11].includes(diff)) score = 60; // Neutral-good
  else if ([2, 4, 10].includes(diff)) score = 50; // Neutral
  else if ([6, 8, 12].includes(diff)) score = 25; // Unfavorable
  
  let note = (score >= 70) ? "Favorable" : (score <= 30) ? "Unfavorable" : "Neutral";
  
  return {house: diff, note, score};
}

function calculateOverallScore(categoryResult, nakResult, rashiResult) {
  let score = 0;
  let weights = {category: 0.5, nakshatra: 0.25, rashi: 0.25};
  
  // Category score
  let catScore = 50;
  if (categoryResult === "Siddha") catScore = 100;
  else if (categoryResult === "Ari") catScore = 0;
  else if (categoryResult.includes("susiddha")) catScore = 75;
  else if (categoryResult.includes("sadhya")) catScore = 60;
  
  score += catScore * weights.category;
  
  // Nakshatra score
  if (nakResult && nakResult.score) {
    score += nakResult.score * weights.nakshatra;
  } else {
    score += 50 * weights.nakshatra; // Default if not provided
  }
  
  // Rashi score
  if (rashiResult && rashiResult.score) {
    score += rashiResult.score * weights.rashi;
  } else {
    score += 50 * weights.rashi; // Default if not provided
  }
  
  return Math.round(score);
}

function calculate() {
  let name = document.getElementById('nameInput').value;
  let mantra = document.getElementById('mantraInput').value;
  
  if (!name || !mantra) { 
    alert("Please enter both Name and Mantra"); 
    return; 
  }

  let nameLetter = parseFirstSyllable(name);
  let mantraLetter = parseFirstSyllable(mantra);
  
  let catName = findCategory(nameLetter);
  let catMantra = findCategory(mantraLetter);
  
  let categoryResult = "Unknown";
  let categoryClass = "result-neutral";
  let note = "";

  if (catName === "unknown" || catMantra === "unknown") {
    categoryResult = "Unknown combination";
    note = "One or both letters not found in mapping";
  } else if (catName === "siddha" && catMantra === "siddha") { 
    categoryResult = "Siddha"; 
    note = "Highly favorable - brings swift results";
    categoryClass = "result-good";
  } else if (catMantra === "ari" || catName === "ari") { 
    categoryResult = "Ari"; 
    note = "Avoid: potentially harmful or obstructive";
    categoryClass = "result-bad";
  } else if (catName === "susiddha" || catMantra === "susiddha") {
    categoryResult = `${catName}‚Äì${catMantra}`;
    note = "Favorable with moderate effort";
    categoryClass = "result-good";
  } else if (catName === "sadhya" || catMantra === "sadhya") {
    categoryResult = `${catName}‚Äì${catMantra}`;
    note = "Requires dedicated practice";
    categoryClass = "result-neutral";
  } else {
    categoryResult = `${catName}‚Äì${catMantra}`;
    note = "Check other factors for clarity";
  }

  let bija = currentBijaMapping[mantraLetter] || "No bƒ´ja mapping found";

  // Nakshatra compatibility
  let nakOpt = document.getElementById("nakshatraInput").value;
  let nakResult = null;
  if (nakOpt) {
    let userNakIndex = nakshatras.indexOf(nakOpt);
    let mantraNakIndex = currentLetterNakMapping[mantraLetter];
    if (mantraNakIndex !== undefined) {
      nakResult = nakshatraCompatibility(userNakIndex, mantraNakIndex);
    }
  }

  // Rashi compatibility
  let rashiOpt = document.getElementById("rashiInput").value;
  let rashiResult = null;
  if (rashiOpt) {
    let userRIndex = rashis.findIndex(r => r.includes(rashiOpt.split(" ")[0]));
    let mantraRIndex = currentLetterRashiMapping[mantraLetter];
    if (mantraRIndex !== undefined) {
      rashiResult = rashiCompatibility(userRIndex, mantraRIndex);
    }
  }

  // Calculate overall score
  let overallScore = calculateOverallScore(categoryResult, nakResult, rashiResult);
  let scoreClass = overallScore >= 70 ? "score-good" : overallScore <= 30 ? "score-bad" : "score-neutral";

  // Generate output HTML
  let outputHTML = `
    <h3>Compatibility Analysis Results</h3>
    
    <div class="result-item ${categoryClass}">
      <div class="result-label">Letter Match Category</div>
      <strong>${categoryResult}</strong> (${nameLetter} + ${mantraLetter})<br>
      ${note}
    </div>
    
    <div class="result-item result-neutral">
      <div class="result-label">Suggested Bƒ´ja Mantra</div>
      <strong style="font-size: 24px;">${bija}</strong><br>
      Based on mantra's first syllable: ${mantraLetter}
    </div>
  `;

  if (nakResult) {
    let nakClass = nakResult.score >= 70 ? "result-good" : nakResult.score <= 30 ? "result-bad" : "result-neutral";
    outputHTML += `
      <div class="result-item ${nakClass}">
        <div class="result-label">Nak·π£atra Compatibility</div>
        <strong>${nakResult.tara}</strong> Tara<br>
        ${nakResult.note} (Score: ${nakResult.score}/100)
      </div>
    `;
  }

  if (rashiResult) {
    let rashiClass = rashiResult.score >= 70 ? "result-good" : rashiResult.score <= 30 ? "result-bad" : "result-neutral";
    outputHTML += `
      <div class="result-item ${rashiClass}">
        <div class="result-label">RƒÅ≈õi House Position</div>
        <strong>House ${rashiResult.house}</strong><br>
        ${rashiResult.note} (Score: ${rashiResult.score}/100)
      </div>
    `;
  }

  outputHTML += `
    <div class="score-meter">
      <div class="score-fill ${scoreClass}" style="width: ${overallScore}%;"></div>
      <div class="score-label">Overall Score: ${overallScore}/100</div>
    </div>
    
    <div style="margin-top: 15px; padding: 15px; background: #f3f4f6; border-radius: 8px;">
      <strong>Interpretation:</strong> 
      ${overallScore >= 80 ? "Highly favorable - excellent compatibility" :
        overallScore >= 60 ? "Favorable - good with proper guidance" :
        overallScore >= 40 ? "Neutral - requires extra dedication" :
        overallScore >= 20 ? "Challenging - consider alternatives" :
        "Unfavorable - strongly recommend different mantra"}
    </div>
  `;

  document.getElementById('output').innerHTML = outputHTML;
  document.getElementById('output').classList.remove('hidden');
}

function clearForm() {
  document.getElementById('nameInput').value = '';
  document.getElementById('mantraInput').value = '';
  document.getElementById('nakshatraInput').value = '';
  document.getElementById('rashiInput').value = '';
  document.getElementById('output').classList.add('hidden');
  document.getElementById('aksaraChart').classList.add('hidden');
}

function showAksaraChart() {
  const chart = document.getElementById('aksaraChart');
  const grid = document.getElementById('aksaraGrid');
  
  if (!chart.classList.contains('hidden')) {
    chart.classList.add('hidden');
    return;
  }
  
  grid.innerHTML = '';
  
  // Create cells for all letters
  const allLetters = new Set();
  for (let category in currentLetterGroups) {
    currentLetterGroups[category].forEach(letter => allLetters.add(letter));
  }
  
  Array.from(allLetters).sort().forEach(letter => {
    const cell = document.createElement('div');
    const category = findCategory(letter);
    cell.className = `aksara-cell aksara-${category}`;
    cell.textContent = letter;
    cell.title = `${letter} - ${category}`;
    grid.appendChild(cell);
  });
  
  chart.classList.remove('hidden');
}

function switchTab(tabName) {
  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });
  
  // Remove active from all tab buttons
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // Show selected tab
  document.getElementById(tabName + 'Tab').classList.add('active');
  
  // Set active tab button
  event.target.classList.add('active');
}

function loadDefaults() {
  document.getElementById('letterGroups').value = JSON.stringify(defaultLetterGroups, null, 2);
  document.getElementById('bijaMapping').value = JSON.stringify(defaultBijaMapping, null, 2);
  document.getElementById('letterNakMapping').value = JSON.stringify(defaultLetterNakMapping, null, 2);
  document.getElementById('letterRashiMapping').value = JSON.stringify(defaultLetterRashiMapping, null, 2);
}

function saveCustom() {
  try {
    currentLetterGroups = JSON.parse(document.getElementById('letterGroups').value);
    currentBijaMapping = JSON.parse(document.getElementById('bijaMapping').value);
    currentLetterNakMapping = JSON.parse(document.getElementById('letterNakMapping').value);
    currentLetterRashiMapping = JSON.parse(document.getElementById('letterRashiMapping').value);
    
    // Save to localStorage
    localStorage.setItem('mantraLetterGroups', JSON.stringify(currentLetterGroups));
    localStorage.setItem('mantraBijaMapping', JSON.stringify(currentBijaMapping));
    localStorage.setItem('mantraLetterNakMapping', JSON.stringify(currentLetterNakMapping));
    localStorage.setItem('mantraLetterRashiMapping', JSON.stringify(currentLetterRashiMapping));
    
    alert('Settings saved successfully!');
  } catch (e) {
    alert('Error parsing JSON. Please check your input.\n' + e.message);
  }
}

function loadFromStorage() {
  try {
    const groups = localStorage.getItem('mantraLetterGroups');
    const bija = localStorage.getItem('mantraBijaMapping');
    const nak = localStorage.getItem('mantraLetterNakMapping');
    const rashi = localStorage.getItem('mantraLetterRashiMapping');
    
    if (groups) currentLetterGroups = JSON.parse(groups);
    if (bija) currentBijaMapping = JSON.parse(bija);
    if (nak) currentLetterNakMapping = JSON.parse(nak);
    if (rashi) currentLetterRashiMapping = JSON.parse(rashi);
  } catch (e) {
    console.log('Error loading from storage:', e);
  }
}

function exportSettings() {
  const settings = {
    letterGroups: currentLetterGroups,
    bijaMapping: currentBijaMapping,
    letterNakMapping: currentLetterNakMapping,
    letterRashiMapping: currentLetterRashiMapping
  };
  
  const blob = new Blob([JSON.stringify(settings, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'mantra-settings.json';
  a.click();
  URL.revokeObjectURL(url);
}

function importSettings() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = function(e) {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = function(event) {
      try {
        const settings = JSON.parse(event.target.result);
        if (settings.letterGroups) currentLetterGroups = settings.letterGroups;
        if (settings.bijaMapping) currentBijaMapping = settings.bijaMapping;
        if (settings.letterNakMapping) currentLetterNakMapping = settings.letterNakMapping;
        if (settings.letterRashiMapping) currentLetterRashiMapping = settings.letterRashiMapping;
        
        // Update textareas
        document.getElementById('letterGroups').value = JSON.stringify(currentLetterGroups, null, 2);
        document.getElementById('bijaMapping').value = JSON.stringify(currentBijaMapping, null, 2);
        document.getElementById('letterNakMapping').value = JSON.stringify(currentLetterNakMapping, null, 2);
        document.getElementById('letterRashiMapping').value = JSON.stringify(currentLetterRashiMapping, null, 2);
        
        saveCustom();
        alert('Settings imported successfully!');
      } catch (e) {
        alert('Error importing settings: ' + e.message);
      }
    };
    reader.readAsText(file);
  };
  input.click();
}
</script>
</body>
</html>